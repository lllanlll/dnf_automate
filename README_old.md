# DNF自动刷图机器人 - 增强版

这是一个基于Python开发的地下城与勇士(DNF)自动刷图工具，具有智能角色定位和精准移动功能。

## 🚀 核心功能特性

- 🎯 **智能角色检测** - 通过绿色HP条识别角色位置
- 🏃 **精准移动系统** - 基于真实角色位置的移动算法
- 👹 **自动怪物攻击** - 红色HP条检测，自动移动到怪物身边攻击
- 💰 **自动金币收集** - HSV颜色检测，智能拾取金币
- 🚪 **智能传送门** - 4种门模板识别，自动进入下一房间
- 🎮 **统一按键控制** - 攻击和拾取都使用X键
- ⚡ **实时屏幕处理** - 60fps+ 处理速度
- 🔧 **自适应分辨率** - 支持2134 x 1200分辨率

## 💡 技术亮点

- **角色位置缓存** - 1秒缓存减少计算开销，提升性能
- **距离智能判断** - 50像素内视为到达目标，避免无效移动
- **多模板匹配** - 4种传送门类型全覆盖，提高识别率
- **HSV色彩空间** - 精确的颜色检测，减少误判
- **实时状态显示** - 详细的检测信息输出，便于调试

## ⚠️ 暂时禁用功能

- 🎁 材料物品检测 (等待更高质量模板)

## 🛠️ 快速开始

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 运行程序
```bash
python dnf_bot.py
```

### 3. 按键控制
- **F1**: 开始/暂停自动刷图
- **F2**: 完全停止程序

## 🧪 测试工具

### 角色检测测试
```bash
python test_character_detection.py
```
**功能说明:**
- 实时显示角色检测结果
- 按空格查看详细信息
- 验证HP条识别准确性
- 显示检测到的角色数量和位置

### 移动系统测试
```bash
python test_movement_system.py
```
**功能说明:**
- 左键点击设置目标位置
- 实时显示移动方向和距离
- 验证移动算法准确性
- 可视化角色和怪物位置关系

### 模板质量分析
```bash
python analyze_templates.py
```
**功能说明:**
- 分析模板图片质量
- 提供优化建议
- 评估识别可靠性
- 生成质量报告

## ⚙️ 配置文件说明

所有配置都在 `config.py` 中集中管理：

### 游戏窗口配置
```python
GAME_WINDOW = {
    "top": 0, 
    "left": 0, 
    "width": 2134, 
    "height": 1200
}
```

### 按键配置
```python
KEYS = {
    'attack': 'x',      # 攻击键
    'pickup': 'x',      # 拾取键
    'move_up': 'up',    # 上移键
    'move_down': 'down', # 下移键
    'move_left': 'left', # 左移键
    'move_right': 'right' # 右移键
}
```

### 检测阈值配置
```python
THRESHOLDS = {
    'door_match': 0.65,     # 门匹配阈值
    'item_match': 0.4,      # 物品匹配阈值
    'movement_precision': 50, # 移动精度(像素)
    'attack_range': 80      # 攻击范围(像素)
}
```

## 📁 项目结构

```
dnf_bot/
├── dnf_bot.py                  # 主程序
├── config.py                   # 配置文件
├── requirements.txt            # 依赖列表
├── test_character_detection.py # 角色检测测试
├── test_movement_system.py     # 移动系统测试
├── analyze_templates.py        # 模板分析工具
├── debug_materials.py          # 调试工具
├── templates/                  # 模板图片目录
│   ├── door1.png              # 传送门模板1
│   ├── door2.png              # 传送门模板2
│   ├── door3.png              # 传送门模板3
│   ├── door4.png              # 传送门模板4
│   ├── item1.png              # 物品模板1(暂停使用)
│   └── item2.png              # 物品模板2(暂停使用)
└── README.md                   # 项目说明
```

## 🔧 算法详解

### 角色检测算法
1. **HSV转换** - 将RGB图像转换为HSV色彩空间
2. **绿色范围检测** - 检测绿色HP条 `[40,70,70] ~ [80,255,255]`
3. **轮廓分析** - 过滤面积在100-2000像素的轮廓
4. **位置计算** - HP条中心下方30像素作为角色位置
5. **结果缓存** - 1秒内复用检测结果，提升性能

### 移动算法
1. **距离计算** - 欧几里得距离公式
2. **方向判断** - 向量归一化确定移动方向
3. **精度控制** - 50像素内认为已到达目标
4. **按键映射** - 根据方向发送对应方向键

### 怪物检测算法
1. **红色HP条检测** - 双范围HSV检测红色
2. **轮廓过滤** - 面积50-1500像素
3. **位置推算** - HP条下方20像素为怪物位置
4. **优先级排序** - 按距离排序，优先攻击最近怪物

## 🎮 部署指南

### Windows EXE打包
项目包含GitHub Actions自动化构建：
```yaml
# .github/workflows/build.yml
- 自动构建Windows可执行文件
- 支持Python 3.11环境
- 包含所有依赖库
```

### 手动打包
```bash
pip install pyinstaller
pyinstaller --onefile --windowed dnf_bot.py
```

## 📈 性能优化

- **屏幕截图优化** - 使用MSS库，比PIL快3倍
- **模板匹配缓存** - 避免重复加载模板
- **角色位置缓存** - 减少不必要的检测计算
- **区域检测** - 仅在相关区域进行检测
- **阈值优化** - 动态调整匹配阈值

## ⚠️ 使用须知

**法律声明:**
- 本工具仅供学习和研究使用
- 使用自动化工具可能违反游戏服务条款
- 请谨慎使用，风险自负
- 不得用于商业用途

**技术限制:**
- 需要游戏窗口可见
- 依赖固定分辨率设置
- 对光照条件有一定要求
- 模板图片质量影响识别率

## 🔮 开发路线图

### 短期计划
- [ ] 优化材料检测模板
- [ ] 添加更多传送门类型
- [ ] 改进角色检测稳定性
- [ ] 增加异常处理机制

### 长期计划
- [ ] AI深度学习优化
- [ ] 路径规划算法
- [ ] OCR文字识别
- [ ] 强化学习策略
- [ ] GUI界面开发
- [ ] 多角色支持

## 💻 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.11+ | 主开发语言 |
| OpenCV | 4.12.0.88 | 图像处理和计算机视觉 |
| PyAutoGUI | 0.9.54 | 自动化控制和按键模拟 |
| NumPy | Latest | 数组处理和数值计算 |
| MSS | Latest | 高性能屏幕截图 |
| Keyboard | Latest | 全局键盘监听 |

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进项目！

### 提交流程
1. Fork项目仓库
2. 创建特性分支
3. 提交代码改动
4. 发起Pull Request

### 代码规范
- 遵循PEP 8代码风格
- 添加必要的注释
- 编写测试用例
- 更新相关文档

## 📞 技术支持

如有问题请通过以下方式联系：
- 提交GitHub Issue
- 查看项目文档
- 运行测试工具进行诊断

---

**免责声明:** 本项目仅供学习交流使用，请遵守相关法律法规和游戏服务条款。
